# Функция "Дополнительная жизнь" - Инструкция по настройке

## Обзор
Добавлена функция "Дополнительная жизнь" в меню проигрыша игры. Игроки могут посмотреть рекламу за вознаграждение, чтобы получить второй шанс на прохождение уровня.

## Что было реализовано

### 1. Обновлен GameOverPanel.gd
- Добавлена кнопка "Дополнительная жизнь" 
- Реализована логика показа рекламы за вознаграждение через YandexSDK
- Добавлена обработка результатов рекламы
- Кнопка показывается только при проигрыше

### 2. Обновлены скрипты уровней
- **Game.gd**: Обновлены функции `_handle_game_over()`, `_show_win_panel()`, `_show_lose_panel()`
- **Game_level_5.gd**: Обновлена функция `_show_win_panel()`
- Все функции теперь передают путь к текущей сцене для возможности перезапуска

### 3. Добавлена локализация
- Русский: "Дополнительная жизнь"
- Английский: "Extra Life"
- Ключ перевода: `ui.extra_life.button`

### 4. Создан тестовый скрипт
- **AdTester.gd**: Для тестирования работы рекламы в редакторе
- Управление: Enter - тест рекламы за вознаграждение, Escape - тест обычной рекламы

## Как работает

### Схема работы функции "Дополнительная жизнь":

```
Игрок проигрывает
       ↓
Показывается GameOverPanel
       ↓
┌─────────────────────────────────┐
│        Игра окончена           │
│         Очки: [score]          │
│                                │
│    [Дополнительная жизнь]      │  ← Кнопка появляется только при проигрыше
│         [Меню]                 │
└─────────────────────────────────┘
       ↓ (нажатие кнопки)
YandexSDK.show_rewarded_ad()
       ↓
┌─────────────────────────────────┐
│        Показ рекламы            │
└─────────────────────────────────┘
       ↓
┌─────────────────────────────────┐
│     Обработка результата        │
│                                │
│  "rewarded" → Перезапуск уровня │
│  "closed"   → Ничего не делать  │
│  "error"    → Перезапуск уровня │
└─────────────────────────────────┘
```

### При проигрыше:
1. Показывается меню с кнопками:
   - "Очки" (отображается счет)
   - "Меню" (возврат в главное меню)
   - "Дополнительная жизнь" (просмотр рекламы)

### При нажатии "Дополнительная жизнь":
1. Вызывается `YandexSDK.show_rewarded_ad()`
2. Показывается реклама за вознаграждение
3. После просмотра рекламы:
   - Если `result == "rewarded"` - уровень перезапускается
   - Если `result == "closed"` - ничего не происходит
   - Если `result == "error"` - уровень перезапускается (fallback)

## Настройка Yandex Games SDK

### 1. Убедитесь, что SDK подключен
В `project.godot` должна быть строка:
```
YandexSDK="*res://addons/godot-yandex-games-sdk-main/yandex_sdk.gd"
```

### 2. Включите плагин
В настройках проекта → Plugins → включите "YandexSDK"

### 3. Настройте экспорт для Yandex Games
- Создайте пресет экспорта для Web
- Включите функцию "yandex" в настройках экспорта
- Укажите ID вашей игры в Yandex Games

### 4. Тестирование
- В редакторе: используйте AdTester.gd
- На Yandex Games: реклама будет работать автоматически

## Структура кода

### GameOverPanel.gd
```gdscript
# Основные переменные
const ENABLE_ADS_RETRY := true  # Включение/выключение рекламы
var _current_scene_path: String = ""  # Путь к текущей сцене

# Основные функции
func show_game_over(score: int, is_win: bool, next_scene_path: String = "", current_scene_path: String = "")
func _on_ads_pressed()  # Обработчик нажатия кнопки
func _on_rewarded_ad_result(result: String)  # Обработчик результата рекламы
func _restart_current_level()  # Перезапуск уровня
```

### Интеграция с уровнями
Все скрипты уровней теперь вызывают:
```gdscript
game_over_panel.show_game_over(score, is_win, next_scene_path, current_scene_path)
```

## Отладка

### Логи в консоли
- "Показываем рекламу за вознаграждение..." - при нажатии кнопки
- "Результат рекламы: [result]" - результат просмотра
- "Игрок получил награду! Перезапускаем уровень..." - при успешном просмотре
- "Перезапускаем уровень: [path]" - при перезапуске

### Тестирование без SDK
Если YandexSDK недоступен, уровень все равно перезапустится (fallback режим).

## Возможные проблемы

1. **Реклама не показывается**
   - Проверьте настройки экспорта
   - Убедитесь, что игра запущена на Yandex Games
   - Проверьте логи в консоли браузера

2. **Кнопка не появляется**
   - Проверьте, что `ENABLE_ADS_RETRY = true`
   - Убедитесь, что игра проиграна (не выиграна)

3. **Уровень не перезапускается**
   - Проверьте, что `_current_scene_path` передается корректно
   - Убедитесь, что путь к сцене существует

## Дополнительные возможности

### Настройка текста кнопки
Измените переводы в файлах:
- `i18n/ui_ru.po` - для русского языка
- `i18n/ui_en.po` - для английского языка

### Включение/выключение функции
Измените `ENABLE_ADS_RETRY` в `GameOverPanel.gd`:
- `true` - функция включена
- `false` - функция отключена

### Кастомизация стилей кнопки
Кнопка создается программно, стили можно изменить в функции `_ready()` класса `GameOverPanel`.